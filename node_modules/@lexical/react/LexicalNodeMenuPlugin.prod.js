/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';var k=require("@lexical/react/LexicalComposerContext"),u=require("lexical"),w=require("react"),y=require("@lexical/utils"),z="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement?w.useLayoutEffect:w.useEffect;class A{constructor(b){this.key=b;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(b){this.ref={current:b}}}
let B=b=>{const a=document.getElementById("typeahead-menu");if(a){var f=a.getBoundingClientRect();f.top+f.height>window.innerHeight&&a.scrollIntoView({block:"center"});0>f.top&&a.scrollIntoView({block:"center"});b.scrollIntoView({block:"nearest"})}};
function C(b){var a=u.$getSelection();if(!u.$isRangeSelection(a)||!a.isCollapsed())return null;var f=a.anchor;if("text"!==f.type)return null;a=f.getNode();if(!a.isSimpleText())return null;f=f.offset;let h=a.getTextContent().slice(0,f);var g=b.matchingString;b=b.replaceableString.length;for(let m=b;m<=g.length;m++)h.substr(-m)===g.substr(0,m)&&(b=m);b=f-b;if(0>b)return null;let t;0===b?[t]=a.splitText(f):[,t]=a.splitText(b,f);return t}
function D(b,a){let f=getComputedStyle(b),h="absolute"===f.position;a=a?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===f.position)return document.body;for(;b=b.parentElement;)if(f=getComputedStyle(b),(!h||"static"!==f.position)&&a.test(f.overflow+f.overflowY+f.overflowX))return b;return document.body}function E(b,a){b=b.getBoundingClientRect();a=a.getBoundingClientRect();return b.top>a.top&&b.top<a.bottom}
function F(b,a,f,h){let [g]=k.useLexicalComposerContext();w.useEffect(()=>{if(null!=a&&null!=b){let t=g.getRootElement(),m=null!=t?D(t,!1):document.body,n=!1,c=E(a,m),d=function(){n||(window.requestAnimationFrame(function(){f();n=!1}),n=!0);const q=E(a,m);q!==c&&(c=q,null!=h&&h(q))},p=new ResizeObserver(f);window.addEventListener("resize",f);document.addEventListener("scroll",d,{capture:!0,passive:!0});p.observe(a);return()=>{p.unobserve(a);window.removeEventListener("resize",f);document.removeEventListener("scroll",
d,!0)}}},[a,g,h,f,b])}let G=u.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");
function H({close:b,editor:a,anchorElementRef:f,resolution:h,options:g,menuRenderFn:t,onSelectOption:m,shouldSplitNodeWithQuery:n=!1,commandPriority:c=u.COMMAND_PRIORITY_LOW}){let [d,p]=w.useState(null);w.useEffect(()=>{p(0)},[h.match&&h.match.matchingString]);let q=w.useCallback(e=>{a.update(()=>{const l=null!=h.match&&n?C(h.match):null;m(e,l,b,h.match?h.match.matchingString:"")})},[a,n,h.match,m,b]),r=w.useCallback(e=>{const l=a.getRootElement();null!==l&&(l.setAttribute("aria-activedescendant",
"typeahead-item-"+e),p(e))},[a]);w.useEffect(()=>()=>{let e=a.getRootElement();null!==e&&e.removeAttribute("aria-activedescendant")},[a]);z(()=>{null===g?p(null):null===d&&r(0)},[g,d,r]);w.useEffect(()=>y.mergeRegister(a.registerCommand(G,({option:e})=>e.ref&&null!=e.ref.current?(B(e.ref.current),!0):!1,c)),[a,r,c]);w.useEffect(()=>y.mergeRegister(a.registerCommand(u.KEY_ARROW_DOWN_COMMAND,e=>{if(null!==g&&g.length&&null!==d){let l=d!==g.length-1?d+1:0;r(l);let x=g[l];null!=x.ref&&x.ref.current&&
a.dispatchCommand(G,{index:l,option:x});e.preventDefault();e.stopImmediatePropagation()}return!0},c),a.registerCommand(u.KEY_ARROW_UP_COMMAND,e=>{if(null!==g&&g.length&&null!==d){var l=0!==d?d-1:g.length-1;r(l);l=g[l];null!=l.ref&&l.ref.current&&B(l.ref.current);e.preventDefault();e.stopImmediatePropagation()}return!0},c),a.registerCommand(u.KEY_ESCAPE_COMMAND,e=>{e.preventDefault();e.stopImmediatePropagation();b();return!0},c),a.registerCommand(u.KEY_TAB_COMMAND,e=>{if(null===g||null===d||null==
g[d])return!1;e.preventDefault();e.stopImmediatePropagation();q(g[d]);return!0},c),a.registerCommand(u.KEY_ENTER_COMMAND,e=>{if(null===g||null===d||null==g[d])return!1;null!==e&&(e.preventDefault(),e.stopImmediatePropagation());q(g[d]);return!0},c)),[q,b,a,g,d,r,c]);let v=w.useMemo(()=>({options:g,selectOptionAndCleanUp:q,selectedIndex:d,setHighlightedIndex:p}),[q,d,g]);return t(f,v,h.match?h.match.matchingString:"")}
function I(b,a,f){let [h]=k.useLexicalComposerContext(),g=w.useRef(document.createElement("div")),t=w.useCallback(()=>{g.current.style.top=g.current.style.bottom;const n=h.getRootElement(),c=g.current;var d=c.firstChild;if(null!==n&&null!==b){const {left:q,top:r,width:v,height:e}=b.getRect();c.style.top=`${r+window.pageYOffset+g.current.offsetHeight+3}px`;c.style.left=`${q+window.pageXOffset}px`;c.style.height=`${e}px`;c.style.width=`${v}px`;if(null!==d){d.style.top=`${r}`;var p=d.getBoundingClientRect();
d=p.height;p=p.width;const l=n.getBoundingClientRect();q+p>l.right&&(c.style.left=`${l.right-p+window.pageXOffset}px`);(r+d>window.innerHeight||r+d>l.bottom)&&r-l.top>d&&(c.style.top=`${r-d+window.pageYOffset-e}px`)}c.isConnected||(null!=f&&(c.className=f),c.setAttribute("aria-label","Typeahead menu"),c.setAttribute("id","typeahead-menu"),c.setAttribute("role","listbox"),c.style.display="block",c.style.position="absolute",document.body.append(c));g.current=c;n.setAttribute("aria-controls","typeahead-menu")}},
[h,b,f]);w.useEffect(()=>{let n=h.getRootElement();if(null!==b)return t(),()=>{null!==n&&n.removeAttribute("aria-controls");let c=g.current;null!==c&&c.isConnected&&c.remove()}},[h,t,b]);let m=w.useCallback(n=>{null!==b&&(n||a(null))},[b,a]);F(b,g.current,t,m);return g}function J(b){w.startTransition?w.startTransition(b):b()}
exports.LexicalNodeMenuPlugin=function({options:b,nodeKey:a,onClose:f,onOpen:h,onSelectOption:g,menuRenderFn:t,anchorClassName:m,commandPriority:n=u.COMMAND_PRIORITY_LOW}){let [c]=k.useLexicalComposerContext(),[d,p]=w.useState(null);m=I(d,p,m);let q=w.useCallback(()=>{p(null);null!=f&&null!==d&&f()},[f,d]),r=w.useCallback(e=>{p(e);null!=h&&null===d&&h(e)},[h,d]),v=w.useCallback(()=>{a?c.update(()=>{const e=u.$getNodeByKey(a),l=c.getElementByKey(a);null!=e&&null!=l&&null==d&&J(()=>r({getRect:()=>l.getBoundingClientRect()}))}):
null==a&&null!=d&&q()},[q,c,a,r,d]);w.useEffect(()=>{v()},[v,a]);w.useEffect(()=>{if(null!=a)return c.registerUpdateListener(({dirtyElements:e})=>{e.get(a)&&v()})},[c,v,a]);return null===d||null===c?null:w.createElement(H,{close:q,resolution:d,editor:c,anchorElementRef:m,options:b,menuRenderFn:t,onSelectOption:g,commandPriority:n})};exports.MenuOption=A
