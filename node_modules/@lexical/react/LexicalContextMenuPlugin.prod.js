/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';var k=require("@lexical/react/LexicalComposerContext"),u=require("lexical"),x=require("react"),y=require("@lexical/utils"),z="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement?x.useLayoutEffect:x.useEffect;class A{constructor(b){this.key=b;this.ref={current:null};this.setRefElement=this.setRefElement.bind(this)}setRefElement(b){this.ref={current:b}}}
let B=b=>{const a=document.getElementById("typeahead-menu");if(a){var d=a.getBoundingClientRect();d.top+d.height>window.innerHeight&&a.scrollIntoView({block:"center"});0>d.top&&a.scrollIntoView({block:"center"});b.scrollIntoView({block:"nearest"})}};
function C(b){var a=u.$getSelection();if(!u.$isRangeSelection(a)||!a.isCollapsed())return null;var d=a.anchor;if("text"!==d.type)return null;a=d.getNode();if(!a.isSimpleText())return null;d=d.offset;let l=a.getTextContent().slice(0,d);var e=b.matchingString;b=b.replaceableString.length;for(let t=b;t<=e.length;t++)l.substr(-t)===e.substr(0,t)&&(b=t);b=d-b;if(0>b)return null;let p;0===b?[p]=a.splitText(d):[,p]=a.splitText(b,d);return p}
function D(b,a){let d=getComputedStyle(b),l="absolute"===d.position;a=a?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===d.position)return document.body;for(;b=b.parentElement;)if(d=getComputedStyle(b),(!l||"static"!==d.position)&&a.test(d.overflow+d.overflowY+d.overflowX))return b;return document.body}function E(b,a){b=b.getBoundingClientRect();a=a.getBoundingClientRect();return b.top>a.top&&b.top<a.bottom}
function F(b,a,d,l){let [e]=k.useLexicalComposerContext();x.useEffect(()=>{if(null!=a&&null!=b){let p=e.getRootElement(),t=null!=p?D(p,!1):document.body,m=!1,c=E(a,t),h=function(){m||(window.requestAnimationFrame(function(){d();m=!1}),m=!0);const q=E(a,t);q!==c&&(c=q,null!=l&&l(q))},n=new ResizeObserver(d);window.addEventListener("resize",d);document.addEventListener("scroll",h,{capture:!0,passive:!0});n.observe(a);return()=>{n.unobserve(a);window.removeEventListener("resize",d);document.removeEventListener("scroll",
h,!0)}}},[a,e,l,d,b])}let G=u.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");
function H({close:b,editor:a,anchorElementRef:d,resolution:l,options:e,menuRenderFn:p,onSelectOption:t,shouldSplitNodeWithQuery:m=!1,commandPriority:c=u.COMMAND_PRIORITY_LOW}){let [h,n]=x.useState(null);x.useEffect(()=>{n(0)},[l.match&&l.match.matchingString]);let q=x.useCallback(g=>{a.update(()=>{const f=null!=l.match&&m?C(l.match):null;t(g,f,b,l.match?l.match.matchingString:"")})},[a,m,l.match,t,b]),r=x.useCallback(g=>{const f=a.getRootElement();null!==f&&(f.setAttribute("aria-activedescendant",
"typeahead-item-"+g),n(g))},[a]);x.useEffect(()=>()=>{let g=a.getRootElement();null!==g&&g.removeAttribute("aria-activedescendant")},[a]);z(()=>{null===e?n(null):null===h&&r(0)},[e,h,r]);x.useEffect(()=>y.mergeRegister(a.registerCommand(G,({option:g})=>g.ref&&null!=g.ref.current?(B(g.ref.current),!0):!1,c)),[a,r,c]);x.useEffect(()=>y.mergeRegister(a.registerCommand(u.KEY_ARROW_DOWN_COMMAND,g=>{if(null!==e&&e.length&&null!==h){let f=h!==e.length-1?h+1:0;r(f);let w=e[f];null!=w.ref&&w.ref.current&&
a.dispatchCommand(G,{index:f,option:w});g.preventDefault();g.stopImmediatePropagation()}return!0},c),a.registerCommand(u.KEY_ARROW_UP_COMMAND,g=>{if(null!==e&&e.length&&null!==h){var f=0!==h?h-1:e.length-1;r(f);f=e[f];null!=f.ref&&f.ref.current&&B(f.ref.current);g.preventDefault();g.stopImmediatePropagation()}return!0},c),a.registerCommand(u.KEY_ESCAPE_COMMAND,g=>{g.preventDefault();g.stopImmediatePropagation();b();return!0},c),a.registerCommand(u.KEY_TAB_COMMAND,g=>{if(null===e||null===h||null==
e[h])return!1;g.preventDefault();g.stopImmediatePropagation();q(e[h]);return!0},c),a.registerCommand(u.KEY_ENTER_COMMAND,g=>{if(null===e||null===h||null==e[h])return!1;null!==g&&(g.preventDefault(),g.stopImmediatePropagation());q(e[h]);return!0},c)),[q,b,a,e,h,r,c]);let v=x.useMemo(()=>({options:e,selectOptionAndCleanUp:q,selectedIndex:h,setHighlightedIndex:n}),[q,h,e]);return p(d,v,l.match?l.match.matchingString:"")}
function I(b,a,d){let [l]=k.useLexicalComposerContext(),e=x.useRef(document.createElement("div")),p=x.useCallback(()=>{e.current.style.top=e.current.style.bottom;const m=l.getRootElement(),c=e.current;var h=c.firstChild;if(null!==m&&null!==b){const {left:q,top:r,width:v,height:g}=b.getRect();c.style.top=`${r+window.pageYOffset+e.current.offsetHeight+3}px`;c.style.left=`${q+window.pageXOffset}px`;c.style.height=`${g}px`;c.style.width=`${v}px`;if(null!==h){h.style.top=`${r}`;var n=h.getBoundingClientRect();
h=n.height;n=n.width;const f=m.getBoundingClientRect();q+n>f.right&&(c.style.left=`${f.right-n+window.pageXOffset}px`);(r+h>window.innerHeight||r+h>f.bottom)&&r-f.top>h&&(c.style.top=`${r-h+window.pageYOffset-g}px`)}c.isConnected||(null!=d&&(c.className=d),c.setAttribute("aria-label","Typeahead menu"),c.setAttribute("id","typeahead-menu"),c.setAttribute("role","listbox"),c.style.display="block",c.style.position="absolute",document.body.append(c));e.current=c;m.setAttribute("aria-controls","typeahead-menu")}},
[l,b,d]);x.useEffect(()=>{let m=l.getRootElement();if(null!==b)return p(),()=>{null!==m&&m.removeAttribute("aria-controls");let c=e.current;null!==c&&c.isConnected&&c.remove()}},[l,p,b]);let t=x.useCallback(m=>{null!==b&&(m||a(null))},[b,a]);F(b,e.current,p,t);return e}
exports.LexicalContextMenuPlugin=function({options:b,onClose:a,onOpen:d,onSelectOption:l,menuRenderFn:e,anchorClassName:p,commandPriority:t=u.COMMAND_PRIORITY_LOW}){let [m]=k.useLexicalComposerContext(),[c,h]=x.useState(null),n=x.useRef(null);p=I(c,h,p);let q=x.useCallback(()=>{h(null);null!=a&&null!==c&&a()},[a,c]),r=x.useCallback(f=>{h(f);null!=d&&null===c&&d(f)},[d,c]),v=x.useCallback(f=>{f.preventDefault();r({getRect:()=>new DOMRect(f.clientX,f.clientY,1,1)})},[r]),g=x.useCallback(f=>{null===
c||null==n.current||null==f.target||n.current.contains(f.target)||q()},[q,c]);x.useEffect(()=>{let f=m.getRootElement();if(f)return f.addEventListener("contextmenu",v),()=>f.removeEventListener("contextmenu",v)},[m,v]);x.useEffect(()=>{document.addEventListener("click",g);return()=>document.removeEventListener("click",g)},[m,g]);return null===c||null===m?null:x.createElement(H,{close:q,resolution:c,editor:m,anchorElementRef:p,options:b,menuRenderFn:(f,w)=>e(f,w,{setMenuRef:J=>{n.current=J}}),onSelectOption:l,
commandPriority:t})};exports.MenuOption=A
